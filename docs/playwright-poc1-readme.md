# POC 1: Playwright Headless Recording - Setup & Usage

## Overview

POC 1 demonstrates:
- Running a scripted persona test in a real browser via Playwright
- Recording video + trace of the entire run
- Generating a structured `events.json` log compatible with Mimica's TKF system
- Saving all artifacts for later playback in the Mimica UI

## Installation

### 1. Install Dependencies

```bash
cd /Users/laszlon/Work/ai/repo/mimica
npm install
```

This will install `@playwright/test` from package.json.

### 2. Install Playwright Browsers

```bash
npm run playwright:install
```

This downloads the Chromium browser binaries needed for testing.

## Running POC 1

### Prerequisite: Start the App

Before running Playwright tests, make sure the FocusFlow app is running:

```bash
npm run dev
```

The app should be accessible at `http://localhost:3000`.

### Run the Test

```bash
# Headless mode (default - for reliable video capture)
npm run playwright:gen-z-v1

# Or run all Playwright tests
npm run playwright:test

# Headed mode (see live browser - less reliable for demo)
npm run playwright:run
```

### What Happens

1. Playwright launches a Chromium browser
2. Navigates to `http://localhost:3000/app`
3. Executes the Gen Z Creator persona script (same sequence as `alexV1Sequence` in `simulation-sequences.ts`)
4. Logs each action with reasoning to `EventLogger`
5. Records video + trace automatically
6. Saves outputs to `playwright-runs/<runId>/`

## Output Structure

After running the test, you'll find:

```
playwright-runs/
├── run-1734123456789/          # Unique run ID
│   ├── video.webm              # Full video recording
│   ├── events.json             # Structured event log
│   └── metadata.json           # Run metadata
└── test-results/
    └── <testId>/
        └── trace.zip            # Playwright trace file
```

### events.json Format

```json
[
  {
    "runId": "run-1734123456789",
    "personaId": "gen-z-creator",
    "stepIndex": 0,
    "screenId": "step-0",
    "targetSelector": "[data-element-id=\"goal-option-maximize\"]",
    "targetElementId": "goal-option-maximize",
    "action": "HOVER",
    "reasoningText": "Hmm, \"Maximize Output\"... what does that even mean?",
    "status": "confused",
    "timestamp": 1734123457000,
    "durationMs": 2000
  },
  ...
]
```

### metadata.json Format

```json
{
  "runId": "run-1734123456789",
  "personaId": "gen-z-creator",
  "scenarioId": "onboarding",
  "uiVersion": "v1",
  "mode": "scripted",
  "appUrl": "http://localhost:3000/app",
  "status": "completed",
  "startedAt": "2024-12-10T12:34:56.789Z",
  "completedAt": "2024-12-10T12:35:23.456Z",
  "durationMs": 26667,
  "videoPath": "playwright-runs/run-1734123456789/video.webm",
  "tracePath": "playwright-runs/test-results/abc123/trace.zip",
  "eventsPath": "playwright-runs/run-1734123456789/events.json",
  "source": "playwright-mcp",
  "metadata": {
    "browser": "chromium",
    "playwrightVersion": "1.48.2",
    "eventCount": 17
  }
}
```

## Viewing Results

### Video Playback

```bash
# Open video in your default player
open playwright-runs/run-1734123456789/video.webm
```

### Trace Viewer

```bash
# Open Playwright trace viewer
npx playwright show-trace playwright-runs/test-results/<testId>/trace.zip
```

The trace viewer provides:
- Timeline of all actions
- Screenshots before/after each action
- Network requests
- Console logs
- Source code

### Events JSON

```bash
# Pretty-print events
cat playwright-runs/run-1734123456789/events.json | jq
```

## Next Steps

### Integration with Mimica (Todo)

1. **Create Adapter**: Convert `events.json` → `SimulationStep[]`
2. **Add Video Player**: Component to play recorded videos in lab UI
3. **Run Selector**: UI to select and load Playwright runs
4. **TKF Integration**: Feed Playwright events through `TKFAggregator`

See `docs/playwright-mcp-research.md` for the full integration design.

### POC 2: LLM-Driven Agent

Once POC 1 is validated, we'll extend it to:
- Call an LLM at each step to decide actions
- Capture LLM-generated reasoning in `events.json`
- Support dynamic, non-scripted flows

## Troubleshooting

### "Error: connect ECONNREFUSED 127.0.0.1:3000"

Make sure the Next.js app is running:
```bash
npm run dev
```

### "No video file generated"

Check that `video: 'on'` is set in `playwright.config.ts`.

### "Selector not found"

Verify the FocusFlow app has `data-element-id` attributes on interactive elements. Check `components/onboarding/OnboardingFlow.tsx`.

### Trace file not found

Traces are saved to `playwright-runs/test-results/<testId>/trace.zip`. The test ID is auto-generated by Playwright. Check the console output or `metadata.json` for the exact path.

## Files Created for POC 1

- `lib/playwright/types.ts` - Type definitions
- `lib/playwright/EventLogger.ts` - Event logging utility
- `playwright.config.ts` - Playwright configuration
- `scripts/playwright/gen-z-creator-v1.spec.ts` - Test script
- `docs/playwright-recording-research.md` - Research notes
- `docs/playwright-mcp-research.md` - MCP integration design
- `docs/playwright-poc1-readme.md` - This file

## Success Criteria

POC 1 is successful if:
- ✅ Test runs without errors
- ✅ Video is recorded and playable
- ✅ Trace is captured
- ✅ `events.json` contains all expected events with reasoning
- ✅ `metadata.json` contains accurate run information
- ✅ Events map cleanly to existing `SimulationStep` schema

## Demo Plan

For the hackathon demo:
1. Run POC 1 test before demo to pre-record video
2. Show video in Mimica lab UI (to be implemented)
3. Show TKF insights derived from Playwright events
4. Explain how it works (real browser, real LLM in POC 2)

